<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Pedidos</title>
  <!--<link rel="manifest" href="manifest.json"> -->

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- App styles -->
  <link rel="stylesheet" href="style.css">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2215%22 fill=%22%232563eb%22/><text x=%2250%22 y=%2258%22 font-size=%2255%22 text-anchor=%22middle%22 fill=%22white%22>ל</text></svg>">
</head>
<body>
  <!-- Top Navbar (Falcon-like) -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top shadow-sm">
    <div class="container-fluid">
      <button class="btn btn-outline-primary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar" title="Menu"><i class="bi bi-list"></i></button>
      <a class="navbar-brand fw-semibold d-flex align-items-center" href="#">
        <i class="bi bi-graph-up-arrow text-primary me-2"></i>Dashboard de Pedidos
      </a>
      <!-- pesquisa removida -->
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-light d-none d-md-inline-flex"><i class="bi bi-bell"></i></button>
        <button class="btn btn-light d-none d-md-inline-flex"><i class="bi bi-gear"></i></button>
        <button id="themeToggle" class="btn btn-outline-secondary" type="button" title="Alternar tema"><i class="bi bi-circle-half"></i></button>
        <div class="rounded-circle bg-primary text-white fw-semibold d-inline-flex align-items-center justify-content-center" style="width:32px;height:32px;">PS</div>
      </div>
    </div>
  </nav>

  <!-- floating search removida -->

  <!-- Sidebar (offcanvas) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel">Menu</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="list-unstyled small mb-3">
        <li class="mb-2 text-muted">Navegação</li>
        <li class="mb-1"><a class="link-body-emphasis text-decoration-none" href="index.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
        <li class="mb-1"><a class="link-body-emphasis text-decoration-none" href="acompanhamento.html"><i class="bi bi-graph-up me-2"></i>Acompanhamento de Vendas</a></li>
        <li class="mb-1"><a class="link-body-emphasis text-decoration-none" href="fechamento.html"><i class="bi bi-cash-coin me-2"></i>Fechamento de caixa</a></li>
        <li class="mb-1"><a class="link-body-emphasis text-decoration-none" href="itens.html"><i class="bi bi-list-ul me-2"></i>Itens detalhados</a></li>
      </ul>
    </div>
  </div>

  <main id="sec-dashboard" class="container-fluid py-3">
    <!-- Filtros -->
    <section class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end filters-grid">
          <div class="col-12">
            <label class="form-label mb-1" for="dataInicio">Período</label>
  </div>

  <!-- Floating left menu removido (navegação via offcanvas) -->
          <div class="col-12 col-sm-6 col-lg-3">
            <input type="text" id="dataInicio" class="form-control" placeholder="dd/mm/yy" inputmode="numeric" />
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="d-flex align-items-center gap-2">
              <span class="text-muted d-none d-lg-inline">até</span>
              <input type="text" id="dataFim" class="form-control" placeholder="dd/mm/yy" inputmode="numeric" />
            </div>
          </div>
          <div class="col-6 col-lg-2">
            <button id="btnMesAtual" class="btn btn-outline-secondary btn-sm w-100" type="button" title="Usar mês atual">Mês atual</button>
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label mb-1" for="horaFiltro">Hora</label>
            <select id="horaFiltro" class="form-select">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label mb-1" for="vendedorFiltro">Vendedor</label>
            <select id="vendedorFiltro" class="form-select">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-12 col-lg-auto ms-lg-auto filters-actions">
            <div class="d-flex flex-wrap gap-2">
              <button id="btnAtivarConsultas" class="btn btn-primary" type="button"><i class="bi bi-arrow-repeat me-1"></i>Ativar consultas</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="row g-3 mb-3">
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body d-flex align-items-center">
            <div class="rounded-circle bg-primary-subtle text-primary d-inline-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <div>
              <div class="text-muted small">Faturamento do Período</div>
              <div id="kpi-faturamento" class="fs-4 fw-semibold">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body d-flex align-items-center">
            <div class="rounded-circle bg-info-subtle text-info d-inline-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
              <i class="bi bi-clipboard-data"></i>
            </div>
            <div>
              <div class="text-muted small">Ticket Médio</div>
              <div id="kpi-ticket" class="fs-4 fw-semibold">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body d-flex align-items-center">
            <div class="rounded-circle bg-success-subtle text-success d-inline-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
              <i class="bi bi-receipt"></i>
            </div>
            <div>
              <div class="text-muted small">Nº de Pedidos</div>
              <div id="kpi-pedidos" class="fs-4 fw-semibold">—</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body d-flex align-items-center">
            <div class="rounded-circle bg-warning-subtle text-warning d-inline-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
              <i class="bi bi-buildings"></i>
            </div>
            <div>
              <div class="text-muted small">Empresas</div>
              <div id="kpi-empresas" class="fs-4 fw-semibold">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sparkline cards (Weekly bars like Falcon) -->
    <section class="row g-3 mb-3">
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="text-muted small">Vendas Semanais</div>
              <span class="badge text-bg-success small">7d</span>
            </div>
            <div class="d-flex align-items-end mb-2">
              <div class="display-6 fw-semibold me-2" id="spark-weekly-total">—</div>
              <small class="text-success">+<span id="spark-weekly-diff">0%</span></small>
            </div>
            <div style="height:72px;">
              <canvas id="sparkWeekly"></canvas>
            </div>
            <div id="sparkWeeklyLegend" class="small text-muted mt-2 d-flex flex-wrap gap-3"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="text-muted small mb-2">Pedidos Semanais</div>
            <div class="d-flex align-items-end mb-2">
              <div class="display-6 fw-semibold me-2" id="spark-weekly-orders">—</div>
            </div>
            <div style="height:72px;">
              <canvas id="sparkWeeklyOrders"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cards adicionais: Total Orders (line sparkline), Weather e Running Projects -->
    <section class="row g-3 mb-3">
      <div class="col-12 col-xl-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="text-muted small">Total Orders</div>
              <div class="dropdown">
                <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown">Últimos 7 dias</button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" data-range="7">Últimos 7 dias</a></li>
                  <li><a class="dropdown-item" href="#" data-range="30">Últimos 30 dias</a></li>
                </ul>
              </div>
            </div>
            <div class="d-flex align-items-end mb-2">
              <div class="display-6 fw-semibold me-2" id="metric-orders-total">—</div>
              <small class="text-primary">vs. período</small>
            </div>
            <div style="height:90px;">
              <canvas id="sparkOrdersLine"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-start gap-3">
                <i id="weather-icon" class="bi bi-sun display-6 text-warning"></i>
                <div>
                  <div class="text-muted small">Weather</div>
                  <div class="h3 mb-0"><span id="weather-city">—</span></div>
                  <div class="text-primary small" id="weather-status">—</div>
                  <div class="small text-muted" id="weather-extra">—</div>
                </div>
              </div>
              <div class="display-5 fw-semibold text-primary" id="weather-temp">—</div>
            </div>
            <hr class="my-3"/>
            <div>
              <div class="text-muted small mb-1">Próximos feriados nacionais</div>
              <ul class="list-unstyled small mb-0" id="holidayList"></ul>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="text-muted small">Vendas por Vendedor</div>
              <span class="badge text-bg-primary">Valor de Venda</span>
            </div>
            <ul class="list-group list-group-flush" id="runningProjectsList"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Lista (removida) -->
    <section class="card border-0 shadow-sm mb-3 d-none">
      <div class="card-header bg-transparent d-flex align-items-center justify-content-between">
        <h2 id="listaTitulo" class="h6 mb-0">Lista de Pedidos <span id="listaAviso" class="badge text-bg-primary ms-1">Exibindo 2 (clique para ver 20)</span></h2>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="pedidosTable" class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Num. Pedido</th>
                <th>Data de Emissão</th>
                <th>Total (R$)</th>
                <th>Vendedor</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="row g-3 mb-3">
      <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-transparent">
            <h2 class="h6 mb-0">Top 10 Produtos (Donut)</h2>
          </div>
          <div class="card-body">
            <div class="ratio ratio-1x1">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-8">
        <div class="row g-3">
          <div class="col-12">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-transparent"><h2 class="h6 mb-0">Total por Data</h2></div>
              <div class="card-body">
                <div class="chart-box"><canvas id="lineChart"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-transparent"><h2 class="h6 mb-0">Total por Empresa</h2></div>
              <div class="card-body">
                <div class="chart-box"><canvas id="barChart"></canvas></div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h2 class="h6 mb-0">Faturamento Mensal</h2>
                <div class="dropdown">
                  <button class="btn btn-sm btn-light dropdown-toggle" data-bs-toggle="dropdown"><span id="monthsRangeLabel">6 meses</span></button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#" data-range-months="6">Últimos 6 meses</a></li>
                    <li><a class="dropdown-item" href="#" data-range-months="12">Últimos 12 meses</a></li>
                  </ul>
                </div>
              </div>
              <div class="card-body">
                <div class="chart-box"><canvas id="barMonthly"></canvas></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Seções de navegação -->
    <section id="sec-acompanhamento" class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 mb-0">Acompanhamento de Vendas</h2>
        <div class="text-muted small">Conteúdo a ser implementado</div>
      </div>
    </section>
    <section id="sec-fechamento" class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 mb-0">Fechamento de caixa</h2>
        <div class="text-muted small">Conteúdo a ser implementado</div>
      </div>
    </section>
    <section id="sec-itens" class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h2 class="h6 mb-0">Itens detalhados</h2>
        <div class="text-muted small">Conteúdo a ser implementado</div>
      </div>
    </section>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- Normaliza textos com caracteres corrompidos (mojibake) -->
  <script>
    (function(){
      try{
        const replacements = [
          ['Per��odo','Período'], ['per��odo','período'], ['Navega��ǜo','Navegação'], ['navega��ǜo','navegação'],
          ['MǦs','Mês'], ['MǸdio','Médio'], ['N��','Nº'], ['Emissǜo','Emissão'], ['Pr��ximos','Próximos'],
          ['Conteǧdo','Conteúdo'], ['Sǜo','São'], ['atǸ','até'], ['�sltimos','Últimos'],
          ['Indispon��vel','Indisponível'], ['Dados nǜo dispon��veis','Dados não disponíveis'], ['Nǜo foi poss��vel','Não foi possível'],
          ['CǸu','Céu'], ['Condi��ǜo','Condição'], ['pr��ximos','próximos'],
          ['Mǭx','Máx'], ['M��n','Mín'], ['Precipita��ǜo','Precipitação'],
          ['��','°'], ['�?�','•']
        ];
        const fix = (s) => {
          let out = s;
          for (const [from,to] of replacements){ if (from && to) out = out.split(from).join(to); }
          // Placeholders quebrados
          out = out.split('�?"').join('—');
          return out;
        };
        const normalize = (root) => {
          const walker = document.createTreeWalker(root || document.body, NodeFilter.SHOW_TEXT);
          const nodes = [];
          while (walker.nextNode()) nodes.push(walker.currentNode);
          for (const n of nodes){ const t = fix(n.nodeValue); if (t !== n.nodeValue) n.nodeValue = t; }
        };
        // Inicial
        normalize(document.body);
        // Observa mutações e normaliza textos inseridos dinamicamente
        const mo = new MutationObserver((list) => {
          for (const m of list){
            if (m.type === 'childList'){
              m.addedNodes.forEach(node => { if (node.nodeType === 1) normalize(node); });
            } else if (m.type === 'characterData'){
              m.target.nodeValue = fix(m.target.nodeValue || '');
            }
          }
        });
        mo.observe(document.body, { childList: true, subtree: true, characterData: true });
        // Corrige placeholders conhecidos que ficaram com caractere inválido
        const ids = ['kpi-faturamento','kpi-ticket','kpi-pedidos','kpi-empresas','spark-weekly-total','spark-weekly-orders','metric-orders-total','weather-city','weather-status','weather-extra','weather-temp'];
        ids.forEach(id => { const el = document.getElementById(id); if (el && /�/.test(el.textContent||'')) el.textContent = '—'; });
      }catch(_){ /* ignore */ }
    })();
  </script>

  <!-- App -->
  <script type="module" src="src/main.js?v=2"></script>
</body>
</html>
